@page "/lunch"
@page "/LunchMenu"
@using System.Text.Json
@using SeatingChartApp.Services
@inject NavigationManager Navigation
@inject SchoolEventsService SchoolEvents

<h3>Lunch Menu for @Today.ToString("MMMM dd, yyyy")</h3>

@if (!string.IsNullOrEmpty(EventMessage))
{
    <p><strong>Event:</strong> @EventMessage</p>
}

<ul>
    @foreach (var item in TodayMenu)
    {
        <li>@item</li>
    }
</ul>

@code {
    private DateTime Today = TimeZoneInfo.ConvertTime(DateTime.UtcNow, TimeZoneInfo.FindSystemTimeZoneById("America/New_York"));
    private List<string> TodayMenu = new();
    private string? EventMessage;

    // No-school days that should not advance the lunch menu rotation
    private static readonly HashSet<string> NoSchoolDays = new()
    {
        "2025-08-05", "2025-09-01", // Teacher work day, Labor Day
        "2025-10-06", "2025-10-07", "2025-10-08", "2025-10-09", "2025-10-10", // Fall Break
        "2025-11-07", // No school for elem students
        "2025-11-26", "2025-11-27", "2025-11-28", // Thanksgiving
        "2025-12-19", "2025-12-22", "2025-12-23", "2025-12-24", "2025-12-25", "2025-12-26", // Winter Break part 1
        "2025-12-29", "2025-12-30", "2025-12-31", "2026-01-01", "2026-01-02", "2026-01-05", // Winter Break part 2
        "2026-01-19", "2026-02-16", // MLK, Presidents Day
        "2026-04-06", "2026-04-07", "2026-04-08", "2026-04-09", "2026-04-10", // Spring Break
        "2026-05-25", "2026-05-26" // Memorial Day, Teacher work day
    };

    private List<List<string>> SummerLunches = new()
    {
        new() { "Quesadilla, apples, yogurt chips" },
        new() { "Ham/salami, cantaloupe, chips, baby carrots" },
        new() { "Chicken sticks, strawberries, peppers, chips" },
        new() { "Pizza, oranges/banana, GoGurt" },
        new() { "Kids pick" },
        new() { "Lunchable, blueberries, grapes, cucumbers, chips" },
        new() { "Peanut butter sandwich, apples, cheese sticks, chips" },
        new() { "Fish sticks, pineapple, carrots, chips" },
        new() { "Ham/salami sandwich, oranges, peppers, chips" },
        new() { "Kids pick" },
        new() { "Chicken sticks, blueberries, cucumbers, chips" },
        new() { "Pizza, oranges, banana, yogurt" },
        new() { "Quesadilla, apples, yogurt chips" },
        new() { "Lunchable, blueberry, grapes, chips" },
        new() { "Kids pick" }
    };

    // Updated school lunch menu - 3 weeks rotation (15 items)
    private List<List<string>> SchoolLunches = new()
    {
        // WEEK 1
        new() { "Chicken Nuggets w/ Blueberry Muffin", "Popcorn Chicken Salad", "Buttered Corn" }, // Monday
        new() { "Soft Beef Tacos", "Taco Salad", "Refried Beans" }, // Tuesday
        new() { "Bosco Sticks", "Yogurt Parfait w/ Homemade Granola", "Steamed Broccoli" }, // Wednesday
        new() { "Pasta w/ Assorted Sauces & Garlic Toast", "Taco Salad", "Green Beans" }, // Thursday
        new() { "Chicken Patty Sandwich", "Popcorn Chicken Salad", "Honey Glazed Carrots" }, // Friday

        // WEEK 2
        new() { "Mini Corn Dogs", "Popcorn Chicken Salad", "Smiley Potatoes" }, // Monday
        new() { "Chicken Teriyaki Dumplings", "Taco Salad", "Steamed Broccoli" }, // Tuesday
        new() { "Personal Pan Pizza", "Yogurt Parfait w/ Homemade Granola", "Green Beans" }, // Wednesday
        new() { "Chicken Smackers w/ Dinner Roll", "Taco Salad", "Mashed Potatoes w/ Gravy" }, // Thursday
        new() { "Soft Pretzel w/ Cheese", "Popcorn Chicken Salad", "Baked Beans" }, // Friday

        // WEEK 3
        new() { "Belgium Waffle w/ Sausage Patties", "Popcorn Chicken Salad", "Baked Apples" }, // Monday
        new() { "French Bread Pizza", "Taco Salad", "Buttered Corn" }, // Tuesday
        new() { "Cheeseburger", "Yogurt Parfait w/ Homemade Granola", "Baked Beans" }, // Wednesday
        new() { "Chicken Tenders w/ Corn Muffin", "Taco Salad", "Steamed Broccoli" }, // Thursday
        new() { "Pizza Crunchers w/ Dip", "Popcorn Chicken Salad", "Green Beans" } // Friday
    };

    protected override async Task OnInitializedAsync()
    {
        var easternTime = TimeZoneInfo.FindSystemTimeZoneById("America/New_York");
        var now = TimeZoneInfo.ConvertTime(DateTime.UtcNow, easternTime);
        
        // TIME-based function: After 2 PM ET, show tomorrow's menu
        if (now.Hour >= 14)
            Today = Today.AddDays(1);

        // Handle weekends - show "It's the weekend" message
        if (Today.DayOfWeek == DayOfWeek.Saturday || Today.DayOfWeek == DayOfWeek.Sunday)
        {
            TodayMenu = new() { "It's the weekend! No school lunch today." };
            return;
        }

        // Check for special events first
        try 
        {
            var todaysEvent = await SchoolEvents.GetEventForDateAsync(Today);
            if (todaysEvent != null)
            {
                EventMessage = todaysEvent.Title;
            }

            // Check if it's a school day
            var isSchoolDay = await SchoolEvents.IsSchoolDayAsync(Today);
            if (!isSchoolDay)
            {
                var reason = todaysEvent?.Title ?? "No school today";
                TodayMenu = new() { $"No school lunch today - {reason}" };
                return;
            }
        }
        catch (Exception ex)
        {
            // Fallback to basic weekend check if service fails
            if (Today.DayOfWeek == DayOfWeek.Saturday || Today.DayOfWeek == DayOfWeek.Sunday)
            {
                TodayMenu = new() { "It's the weekend! No school lunch today." };
                return;
            }
        }

        // DATE-based function: Determine if we're in school year using dynamic service
        var isSchoolYear = true;
        try 
        {
            isSchoolYear = await SchoolEvents.IsSchoolDayAsync(Today);
        }
        catch 
        {
            // Fallback to static dates if service fails
            var schoolYearStart = new DateTime(2025, 8, 6);
            var schoolYearEnd = new DateTime(2026, 5, 22);
            isSchoolYear = Today >= schoolYearStart && Today <= schoolYearEnd;
        }

        if (isSchoolYear)
        {
            // School year: 3-week rotation starting Aug 4, 2025 (first day of school)
            // Week 1: Aug 4-8, Week 2: Aug 11-15, Week 3: Aug 18-22, then repeats
            var schoolStart = new DateTime(2025, 8, 4); // Monday, Aug 4 = Week 1, Monday
            
            // Count SCHOOL days (Mon-Fri excluding holidays/breaks) from school start to today
            int schoolDaysPassed = Enumerable.Range(0, (Today.Date - schoolStart.Date).Days)
                .Select(i => schoolStart.AddDays(i))
                .Count(d => {
                    // Must be a weekday
                    if (d.DayOfWeek == DayOfWeek.Saturday || d.DayOfWeek == DayOfWeek.Sunday)
                        return false;
                    
                    // Must not be a no-school day (except include Aug 4 as first day)
                    var dateStr = d.ToString("yyyy-MM-dd");
                    return !NoSchoolDays.Contains(dateStr) || dateStr == "2025-08-04";
                });
            
            // Aug 4 is index 0 (Week 1, Monday), so add school days passed
            int index = schoolDaysPassed % 15;
            
            TodayMenu = SchoolLunches[index];
        }
        else
        {
            // Summer: Calculate weekdays since summer started (May 23, 2025)
            var summerStart = new DateTime(2025, 5, 23);
            int weekdaysPassed = Enumerable.Range(0, (Today - summerStart).Days + 1)
                .Select(i => summerStart.AddDays(i))
                .Count(d => d.DayOfWeek != DayOfWeek.Saturday && d.DayOfWeek != DayOfWeek.Sunday) - 1;

            int index = weekdaysPassed % 15; // 15-item summer lunch rotation
            if (index < 0) index = 0; // Handle edge case
            TodayMenu = SummerLunches[index];
        }
    }
}
