<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Baseball/Softball Game Sheet</title>
  <link rel="stylesheet" href="style.css" type="text/css" media="all" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
<h1>Baseball Game Sheet</h1>
<div id="main">
  <div id="topRow" style="display: flex; flex-wrap: wrap; gap: 1.5rem; justify-content: space-between;">
    <div id="teamManager">
      <h3>Team Management</h3>
      <select id="teamSelector" onchange="loadSelectedTeam()">
        <option value="">-- Select Team --</option>
      </select>
      <div id="teamMetadata" style="margin-top: 1rem;">
        <label>Coach:</label>
        <input type="text" id="coachName" placeholder="Coach Name">
        <br>
        <label>Age Group:</label>
        <input type="text" id="ageGroup" placeholder="Age Group">
        <br>
        <label>Home Field:</label>
        <input type="text" id="homeField" placeholder="Home Field">
      </div>
      <div class="team-actions">
        <button onclick="showNewTeamForm()">+ New Team</button>
        <button onclick="saveTeam()" id="saveTeamBtn">üíæ Save Team</button>
      </div>      
      <div id="newTeamForm" style="margin-top: 1rem; display: none;">
        <label>Team Name:</label>
        <input type="text" id="teamName" placeholder="Team Name" />
      </div>
    </div>

    <div id="gameInfo">
      <h3>Game Information</h3>
      <label for="gameDate">Date:</label>
      <input type="date" id="gameDate" value="">
      <br>
      <label for="gameTime">Time:</label>
      <input type="time" id="gameTime" value="">
      <br>
      <label for="gameLocation">Location:</label>
      <input type="text" id="gameLocation" placeholder="Game Location">
      <br>
      <label for="gameOpponent">Opponent:</label>
      <input type="text" id="gameOpponent" placeholder="Opponent Team">
    </div>

    <div id="fieldSetup">
      <h3>Choose a field setup:</h3>
      <input type="radio" id="setup9" name="fieldSetup" value="9" checked> 9 players<br>
      <input type="radio" id="setup10" name="fieldSetup" value="10"> 10 players<br>
      <input type="radio" id="setup11" name="fieldSetup" value="11"> 11 players<br>
      <input type="radio" id="setup12" name="fieldSetup" value="12"> 12 players<br>
    </div>

    <form id="lineupForm">
      <h3>Game Lineup</h3>
      <ol id="d"></ol>
      <button type="button" onclick="addPlayer()">+ Add Player</button>
    </form>
  </div>

  <div id="playerRoster">
    <h3 style="display: flex; justify-content: space-between; align-items: center;">
      <span>Player Roster <span id="activeTeamName" style="font-weight: normal; font-style: italic; color: #666;"></span></span>
      <span id="toggleRoster" style="cursor: pointer; font-size: 1.2em;">‚ñæ</span>
    </h3>
    <table id="playerTable">
      <thead>
        <tr>
          <th>First</th><th>Last</th><th>Home #</th><th>Away #</th>
          <th>Bats</th><th>Fields</th><th>Primary</th><th>Secondary</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addPlayerRow()">Add Player</button>
  </div>

  <div id="positionsContainer"></div>
  <div id="inningsContainer">
    <div class="print-page">
        <div id="inning1" class="inning"><h4>Inning 1</h4><div class="positionsContainer"></div></div>
        <div id="inning2" class="inning"><h4>Inning 2</h4><div class="positionsContainer"></div></div>
        <div id="inning3" class="inning"><h4>Inning 3</h4><div class="positionsContainer"></div></div>
    </div>
    <div class="print-page">
        <div id="inning4" class="inning"><h4>Inning 4</h4><div class="positionsContainer"></div></div>
        <div id="inning5" class="inning"><h4>Inning 5</h4><div class="positionsContainer"></div></div>
        <div id="inning6" class="inning"><h4>Inning 6</h4><div class="positionsContainer"></div></div>
    </div>
  </div>
</div>
  <!-- Action Buttons -->
  <div id="buttonContainer" style="text-align: center; margin-top: 1rem; padding: 1rem; border-top: 2px solid #ddd;">
    <h4>Game Actions</h4>
    <button onclick="saveLineupToLocalStorage()" style="background: #28a745; color: white; padding: 10px 20px; margin: 5px;">üíæ Save Lineup & Game</button>
    <button onclick="loadLineupFromLocalStorage()" style="background: #007bff; color: white; padding: 10px 20px; margin: 5px;">üìÇ Load Saved Lineup</button>
    <button onclick="localStorage.clear(); location.reload();" style="background: #dc3545; color: white; padding: 10px 20px; margin: 5px;">üóëÔ∏è Clear All Data</button>
  </div>
  

<!-- SCRIPT SECTION -->
<script>
let teams = JSON.parse(localStorage.getItem('teams') || '{}');
let selectedPlayers = {};

    async function saveTeam() {
        // Try to get from input first (new team), otherwise use selected team
        const inputTeamName = $('#teamName').val().trim();
        const selectedTeamName = $('#teamSelector').val();
        const teamName = inputTeamName || selectedTeamName;

        if (!teamName) {
            alert('Enter a team name or select a team to update.');
            return;
        }
        
        console.log('Saving team:', teamName);

        const players = [];
        $('#playerTable tbody tr').each(function () {
            const player = {};
            $(this).find('input, select').each(function () {
            const key = $(this).attr('name');
            player[key] = $(this).val();
            });
            players.push(player);
        });

        // Collect metadata fields
        const coach = $('#coachName').val();
        const ageGroup = $('#ageGroup').val();
        const homeField = $('#homeField').val();

        // Convert players to match API model
        const apiPlayers = players.map(p => ({
            name: `${p.first || ''} ${p.last || ''}`.trim() || 'Unknown Player',
            jerseyNumber: parseInt(p.home || p.away || '0') || 0,
            preferredPosition: p.primary || '',
            isActive: true
        }));

        const teamData = {
            name: teamName,
            coach,
            league: ageGroup // Map ageGroup to league field
            // Don't include players in team creation, add them separately
        };

        try {
            console.log('Attempting to save team:', teamData);
            
            // Check if this is an update (team exists) or create new
            const isUpdate = teams[teamName] && teams[teamName].id;
            const url = isUpdate ? `/api/lineup/teams/${teams[teamName].id}` : '/api/lineup/teams';
            const method = isUpdate ? 'PUT' : 'POST';

            console.log(`Making ${method} request to ${url}`);

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(teamData)
            });

            console.log('Response status:', response.status);

            if (response.ok) {
                const savedTeam = await response.json();
                console.log('Team saved successfully:', savedTeam);
                
                // Now save players individually
                const savedPlayers = [];
                for (const apiPlayer of apiPlayers) {
                    try {
                        const playerResponse = await fetch(`/api/lineup/teams/${savedTeam.id}/players`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(apiPlayer)
                        });
                        
                        if (playerResponse.ok) {
                            const savedPlayer = await playerResponse.json();
                            console.log('Player saved:', savedPlayer);
                            
                            // Convert to HTML format
                            const nameParts = savedPlayer.name.split(' ');
                            savedPlayers.push({
                                first: nameParts[0] || '',
                                last: nameParts.slice(1).join(' ') || '',
                                home: savedPlayer.jerseyNumber?.toString() || '',
                                away: '',
                                bats: 'R',
                                fields: 'R',
                                primary: savedPlayer.preferredPosition || '',
                                secondary: '',
                                id: savedPlayer.id
                            });
                        } else {
                            const playerErrorText = await playerResponse.text();
                            console.error('Failed to save player:', apiPlayer, 'Error:', playerResponse.status, playerErrorText);
                        }
                    } catch (playerError) {
                        console.error('Error saving player:', apiPlayer, playerError);
                    }
                }
                
                // Update local teams object
                teams[teamName] = {
                    id: savedTeam.id,
                    players: savedPlayers,
                    coach: savedTeam.coach,
                    ageGroup: savedTeam.league || '',
                    homeField: savedTeam.homeField || ''
                };

                // Also save to localStorage as backup
                localStorage.setItem('teams', JSON.stringify(teams));
                
                $('#activeTeamName').text(`‚Äì ${teamName}`);
                $('#newTeamForm').hide(); // Hide new team form after saving
                $('#teamSelector').val(teamName); // Select the saved team
                await loadTeams(); // Refresh the dropdown
                alert(`Saved team: ${teamName} with ${savedPlayers.length} players`);
            } else {
                const errorText = await response.text();
                console.error('Save team failed:', response.status, errorText);
                alert(`Failed to save team (${response.status}): ${errorText}`);
            }
        } catch (error) {
            console.error('Error saving team:', error);
            alert('Error saving team to database, saved to localStorage as backup');
            
            // Fallback to localStorage save
            teams[teamName] = {
                players,
                coach,
                ageGroup,
                homeField
            };
            localStorage.setItem('teams', JSON.stringify(teams));
            $('#activeTeamName').text(`‚Äì ${teamName}`);
            loadTeams();
        }
    }

    async function loadTeams() {
        try {
            const response = await fetch('/api/lineup/teams');
            if (response.ok) {
                const apiTeams = await response.json();
                teams = {}; // Reset the teams object
                $('#teamSelector').html('<option value="">-- Select Team --</option>');
                
                apiTeams.forEach(team => {
                    // Convert API players to HTML format
                    const htmlPlayers = (team.players || []).map(p => {
                        const nameParts = p.name.split(' ');
                        return {
                            first: nameParts[0] || '',
                            last: nameParts.slice(1).join(' ') || '',
                            home: p.jerseyNumber?.toString() || '',
                            away: '',
                            bats: 'R',
                            fields: 'R',
                            primary: p.preferredPosition || '',
                            secondary: '',
                            id: p.id
                        };
                    });

                    teams[team.name] = {
                        id: team.id,
                        players: htmlPlayers,
                        coach: team.coach,
                        ageGroup: team.league || '', // Map league to ageGroup
                        homeField: team.homeField || ''
                    };
                    $('#teamSelector').append(`<option value="${team.name}">${team.name}</option>`);
                });
            } else {
                console.error('Failed to load teams from API, falling back to localStorage');
                // Fallback to localStorage if API fails
                $('#teamSelector').html('<option value="">-- Select Team --</option>');
                Object.keys(teams).forEach(team => {
                    $('#teamSelector').append(`<option value="${team}">${team}</option>`);
                });
            }
        } catch (error) {
            console.error('Error loading teams:', error);
            // Fallback to localStorage if API fails
            $('#teamSelector').html('<option value="">-- Select Team --</option>');
            Object.keys(teams).forEach(team => {
                $('#teamSelector').append(`<option value="${team}">${team}</option>`);
            });
        }
    }
    async function loadSelectedTeam() {
        const team = $('#teamSelector').val();
        if (!team) {
            // Clear everything when no team selected
            $('#playerTable tbody').empty();
            $('#teamMetadata input').val('');
            $('#newTeamForm').hide();
            $('#activeTeamName').text('');
            return;
        }

        // Don't load if we're in the middle of creating a new team
        if ($('#newTeamForm').is(':visible') && $('#teamName').val().trim()) {
            console.log('Not loading team - currently creating new team');
            return;
        }

        try {
            // First try to get from our loaded teams object
            let teamData = teams[team];
            
            // If not found or missing details, fetch from API
            if (!teamData || !teamData.id) {
                const response = await fetch('/api/lineup/teams');
                if (response.ok) {
                    const apiTeams = await response.json();
                    const apiTeam = apiTeams.find(t => t.name === team);
                    if (apiTeam) {
                        // Convert API players to HTML format
                        const htmlPlayers = (apiTeam.players || []).map(p => {
                            const nameParts = p.name.split(' ');
                            return {
                                first: nameParts[0] || '',
                                last: nameParts.slice(1).join(' ') || '',
                                home: p.jerseyNumber?.toString() || '',
                                away: '',
                                bats: 'R',
                                fields: 'R',
                                primary: p.preferredPosition || '',
                                secondary: '',
                                id: p.id
                            };
                        });

                        teamData = {
                            id: apiTeam.id,
                            players: htmlPlayers,
                            coach: apiTeam.coach,
                            ageGroup: apiTeam.league || '', // Map league to ageGroup
                            homeField: apiTeam.homeField || ''
                        };
                        teams[team] = teamData; // Update local cache
                    }
                }
            }
        const players = teamData?.players || [];

        $('#playerTable tbody').empty();

        players.forEach(p => {
            const row = createPlayerRow(p);
            $('#playerTable tbody').append(row);
        });

        // ‚úÖ Populate editable inputs
        $('#coachName').val(teamData.coach || '');
        $('#ageGroup').val(teamData.ageGroup || '');
        $('#homeField').val(teamData.homeField || '');
        $('#teamMetadata').show();

        $('#activeTeamName').text(`‚Äì ${team}`);
        $('#newTeamForm').hide();

        // ‚úÖ Ensure there are exactly 9 lineup boxes
        const currentCount = $('#d li').length;
        // console.log(currentCount);
        const requiredCount = 10;
            for (let i = currentCount; i < requiredCount; i++) {
                addPlayer();
                
            }

        // ‚úÖ Reuse existing lineup inputs, don‚Äôt change how many boxes there are
        const names = players.map(p => `${p.first || ''} ${p.last || ''}`.trim()).filter(n => n);
        $('#d li input').each(function (i) {
            $(this).val(names[i] || '');
            // console.log(`Setting input ${i} to: ${names[i] || ''}`);
        });

            updateDropdowns();
        } catch (error) {
            console.error('Error loading team:', error);
            alert('Error loading team details');
        }
    }
    function addPlayerRow(player = {}) {
        const row = createPlayerRow(player);
        $('#playerTable tbody').append(row);
    }

    function createPlayerRow(player = {}) {
        return `
        <tr>
            <td><input name="first" value="${player.first || ''}"/></td>
            <td><input name="last" value="${player.last || ''}"/></td>
            <td><input name="home" value="${player.home || ''}"/></td>
            <td><input name="away" value="${player.away || ''}"/></td>
            <td>
                <select name="bats">
                    <option value="R" ${player.bats === 'R' ? 'selected' : ''}>R</option>
                    <option value="L" ${player.bats === 'L' ? 'selected' : ''}>L</option>
                </select>
            </td>
            <td>
                <select name="fields">
                    <option value="R" ${player.fields === 'R' ? 'selected' : ''}>R</option>
                    <option value="L" ${player.fields === 'L' ? 'selected' : ''}>L</option>
                </select>
            </td>
            <td><input name="primary" value="${player.primary || ''}"/></td>
            <td><input name="secondary" value="${player.secondary || ''}"/></td>
            <td><button type="button" onclick="$(this).closest('tr').remove();">‚úñ</button></td>
        </tr>`;
    }

    function addPlayer(name = '') {
        var playersDiv = document.getElementById('d');
        var newPlayerDiv = document.createElement('li');
        newPlayerDiv.innerHTML = `<input type="text" name="players[]" placeholder="Player Name" maxlength="100" value="${name}">`;
        newPlayerDiv.querySelector('input').addEventListener('blur', updateDropdowns);
        playersDiv.appendChild(newPlayerDiv);
    }

    function initializeLineup(count = 9) {
        $('#d').empty();
        for (let i = 0; i < count; i++) {
            addPlayer();
        }
    }
    function updateFieldSetup(setup) {
        var players = [];
        $('#d li input').each(function() {
            players.push($(this).val());
        });

        var currentSelections = {};
        $('.positions select').each(function() {
            let position = $(this).attr('class').split(' ')[1];
            currentSelections[position] = $(this).val();
        });


        for (let inning = 1; inning <= 6; inning++) {
            var positionsHTML = `
                <div class="positions" id="positions">
                    <select class="position catcher"><option> </option></select>
                    <select class="position pitcher"><option> </option></select>
                    <select class="position first"><option> </option></select>
                    <select class="position second"><option> </option></select>
                    <select class="position short"><option> </option></select>
                    <select class="position third"><option> </option></select>
                    <select class="position left"><option> </option></select>
                    ${setup != 10 ? '<select class="position center"><option> </option></select>' : ''}
                    <select class="position right"><option> </option></select>
                    ${setup >= 10 ? '<select class="position leftcenter"><option> </option></select>' : ''}
                    ${setup >= 10 ? '<select class="position rightcenter"><option> </option></select>' : ''}
                    ${setup >= 12 ? '<select class="position over"><option> </option></select>' : ''}
                    <p>sitting:<br /><span class="sitting"></span></p>
                </div>
            `;
            document.querySelector(`#inning${inning} .positionsContainer`).innerHTML = positionsHTML;

            if (!selectedPlayers[`inning${inning}`]) {
                selectedPlayers[`inning${inning}`] = {};
            }

            $(`#inning${inning} .positions select`).change(function() {
                let position = $(this).attr('class').split(' ')[1];
                selectedPlayers[`inning${inning}`][position] = $(this).val();
                updateDropdowns();
            });
        }

        $('#lineupForm').show();
        for (let position in currentSelections) {
            $('.positions select.' + position).val(currentSelections[position]);
        }
        updateDropdowns();
    }

    function updateDropdowns() {
        const playerNames = [];
        $('#d li input').each(function () {
            const name = $(this).val().trim();
            if (name) playerNames.push(name);
        });

        $('.inning').each(function () {
            $(this).find('.positions select').each(function () {
                const currentSelect = $(this);
                const currentPosition = currentSelect.attr('class').split(' ')[1];
                const currentSelection = currentSelect.val();
                
                // Gather all current selections in this .positions container
                const taken = [];
                currentSelect.closest('.positions').find('select').each(function () {
                    const val = $(this).val();
                    if (val && val !== currentSelection) {
                        taken.push(val);
                    }
                });

                const availableOptions = ['<option> </option>'];
                for (const name of playerNames) {
                    if (!taken.includes(name) || name === currentSelection) {
                        availableOptions.push(`<option${name === currentSelection ? ' selected' : ''}>${name}</option>`);
                    }
                }

                currentSelect.html(availableOptions.join('\n'));
            });
        });

        updateSitting();
    }


function showNewTeamForm() {
    $('#newTeamForm').show();
    $('#teamSelector').val(''); // Clear team selection
    $('#teamName').val(''); // Clear team name
    $('#playerTable tbody').empty(); // Clear player roster
    $('#teamMetadata input').val(''); // Clear metadata
    $('#activeTeamName').text('');
    
    // Add a few empty player rows to get started
    for (let i = 0; i < 3; i++) {
        addPlayerRow();
    }
}


function updateSitting() {
    $('.inning').each(function () {
        let inningId = $(this).attr('id');
        if (!selectedPlayers[inningId]) selectedPlayers[inningId] = {};

        $(this).find('.positions').each(function () {
            var sitting = [];
            $('#d li input').each(function () {
                if ($(this).val() != '') sitting.push($(this).val());
            });

            $(this).find('select').each(function () {
                var sel = $(this).val();
                if (sel) sitting = sitting.filter(p => p !== sel);
            });

            $(this).find('.sitting').html(sitting.join('<br />'));
        });
    });
}

async function saveLineupToLocalStorage() {
    const players = [];
    $('#d li input').each(function () {
        players.push($(this).val());
    });

    const layout = {};
    $('.inning').each(function () {
        const inningId = $(this).attr('id');
        layout[inningId] = {};
        $(this).find('.positions select').each(function () {
            const position = $(this).attr('class').split(' ')[1];
            layout[inningId][position] = $(this).val();
        });
    });

    // Always save to localStorage as backup
    localStorage.setItem('lineup_players', JSON.stringify(players));
    localStorage.setItem('lineup_positions', JSON.stringify(layout));
    
    // Also save to database if we have a selected team
    await saveLineupToDatabase(layout);
}

async function saveLineupToDatabase(layout) {
    const selectedTeam = $('#teamSelector').val();
    console.log('Saving lineup for team:', selectedTeam);
    console.log('Teams object:', teams);
    console.log('Layout:', layout);
    
    if (!selectedTeam || !teams[selectedTeam] || !teams[selectedTeam].id) {
        alert('Please select and save a team first before saving lineup');
        console.log('No team selected or team not saved to database yet');
        return;
    }
    
    const teamData = teams[selectedTeam];
    
    // Check if team has players with IDs
    const playersWithIds = teamData.players.filter(p => p.id);
    console.log('Team players:', teamData.players);
    console.log('Players with IDs:', playersWithIds);
    
    if (playersWithIds.length === 0) {
        alert(`Team has no players saved to database. Please add players to the roster and save the team first. Found ${teamData.players.length} players but none have database IDs.`);
        return;
    }
    
    try {
        
        // Get game details from the form
        const opponent = $('#gameOpponent').val().trim() || 'Practice';
        const gameLocation = $('#gameLocation').val().trim();
        const gameDate = $('#gameDate').val();
        const gameTime = $('#gameTime').val();
        
        // Create full datetime if both date and time are provided
        let gameDatetime = new Date();
        if (gameDate) {
            if (gameTime) {
                gameDatetime = new Date(`${gameDate}T${gameTime}`);
            } else {
                gameDatetime = new Date(gameDate);
            }
        }
        
        const isHome = gameLocation ? gameLocation.toLowerCase().includes('home') : true;
        
        const gameData = {
            opponent: opponent,
            gameDate: gameDatetime.toISOString(),
            location: gameLocation || (isHome ? (teamData.homeField || 'Home Field') : 'Away'),
            isHome: isHome
        };
        
        console.log('Creating game with data:', gameData);
        
        // Create the game
        const gameResponse = await fetch(`/api/lineup/teams/${teamData.id}/games`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(gameData)
        });
        
        if (!gameResponse.ok) {
            const gameError = await gameResponse.text();
            console.error('Game creation failed:', gameResponse.status, gameError);
            throw new Error(`Failed to create game (${gameResponse.status}): ${gameError}`);
        }
        
        const game = await gameResponse.json();
        console.log('Game created successfully:', game);
        
        // Convert the layout to GameLineupPosition format
        const lineupPositions = [];
        
        for (const [inningId, positions] of Object.entries(layout)) {
            const inningNumber = parseInt(inningId.replace('inning', ''));
            
            let battingOrder = 1;
            for (const [positionName, playerName] of Object.entries(positions)) {
                if (playerName && playerName.trim()) {
                    // Find the player by name
                    const player = teamData.players.find(p => 
                        `${p.first || ''} ${p.last || ''}`.trim() === playerName.trim()
                    );
                    
                    if (player && player.id) {
                        lineupPositions.push({
                            playerId: player.id,
                            inning: inningNumber,
                            position: positionName.toUpperCase(),
                            battingOrder: battingOrder++
                        });
                    } else {
                        console.warn(`Player "${playerName}" not found in team roster or missing ID`);
                        // For now, create lineup position without player ID (this might fail on API)
                        lineupPositions.push({
                            playerId: 0, // This will likely cause API error
                            inning: inningNumber,
                            position: positionName.toUpperCase(),
                            battingOrder: battingOrder++
                        });
                    }
                }
            }
        }
        
        console.log('Lineup positions to save:', lineupPositions);
        
        if (lineupPositions.length > 0) {
            const lineupResponse = await fetch(`/api/lineup/games/${game.id}/lineup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(lineupPositions)
            });
            
            if (lineupResponse.ok) {
                alert(`Lineup saved to database for game vs ${opponent}!`);
            } else {
                const lineupError = await lineupResponse.text();
                console.error('Failed to save lineup positions:', lineupResponse.status, lineupError);
                alert(`Game created but lineup positions failed to save (${lineupResponse.status}): ${lineupError}`);
            }
        } else {
            alert('No valid lineup positions found to save');
        }
        
    } catch (error) {
        console.error('Error saving lineup to database:', error);
        alert('Failed to save lineup to database, but saved locally as backup');
    }
}

function loadLineupFromLocalStorage() {
    const savedPlayers = JSON.parse(localStorage.getItem('lineup_players') || '[]');
    const savedPositions = JSON.parse(localStorage.getItem('lineup_positions') || '{}');

    if (savedPlayers.length > 0) {
        updateFieldSetup(savedPlayers.length);
        $('#d li input').each(function (index) {
            $(this).val(savedPlayers[index] || '');
        });
    }

    setTimeout(() => {
        for (let inning in savedPositions) {
            for (let pos in savedPositions[inning]) {
                $(`#${inning} .positions select.${pos}`).val(savedPositions[inning][pos]);
                if (!selectedPlayers[inning]) selectedPlayers[inning] = {};
                selectedPlayers[inning][pos] = savedPositions[inning][pos];
            }
        }
        updateDropdowns();
    }, 100);
}



// INIT
$(document).ready(function () {
    $('#clear').click(function () {
        $('#d li input').val('');
        $('.positions select').html('<option> </option>');
        $('.positions select').addClass('empty');
        $('.sitting').html('');
        selectedPlayers = {};
    });

    $('input[name="fieldSetup"]').change(function () {
        updateFieldSetup(this.value);
    });

    $('#toggleRoster').click(function () {
        $('#playerTable, #playerRoster button').toggle();
        const isVisible = $('#playerTable').is(':visible');
        $(this).text(isVisible ? '‚ñæ' : '‚ñ¥');
    });

    $('#teamName').on('input', function () {
        const name = $(this).val();
        if ($('#teamSelector').val() === '') {
            $('#activeTeamName').text(name ? `‚Äì ${name}` : '');
        }
    });

    loadTeams();
    updateFieldSetup($('input[name="fieldSetup"]:checked').val());
    loadLineupFromLocalStorage();
    initializeLineup();
});
</script>
</body>
</html>
